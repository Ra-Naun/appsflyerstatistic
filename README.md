# appsflyerstatistic

---

По работе надо было сделать сервис для выгрузки данных (статистики событий) с appsflyer в любую sql БД и разработать механизмам поддержания уникальности данных (если одни и те же данные запросить дважды например). Иметь возможность как указывать промежуток, за какой запросить, так и настроить автоматическое добавление данных за прошлый день каждый день.

---

````
# Запуск на деве

```bash
docker compose down && docker compose build && docker compose up -d

если потом добавятся сиды, то:
docker compose exec server yarn sequelize db:seed:all --config=./config/db.js --models-path=./server/DB/models --seeders-path=./server/DB/seeders --migrations-path=./server/DB/migrations
````

````
# Запуск на проде

```bash
docker compose -f docker-compose.prod.yml down && docker compose -f docker-compose.prod.yml build && docker compose -f docker-compose.prod.yml up -d

если потом добавятся сиды, то:
docker compose exec server yarn sequelize db:seed:all --config=./config/db.js --models-path=./server/DB/models --seeders-path=./server/DB/seeders --migrations-path=./server/DB/migrations
````

# Делать выборку из appsflyer указывая только дни. Часы (время) всё равно вырезаются из запроса.

## Создана система поддержания уникальности контента.

### При пересечении диапазонов дат или event_name, например первый запрос `?from=2022-09-01&to=2022-10-30`, а второй `?from=2022-08-01&to=2022-12-31` - при первом запрос в бд будут добавлены данные за `2022-09-01 - 2022-10-30` промежуток, а при втором запросе за `2022-08-01 - 2022-08-31` и `2022-12-01 - 2022-12-31` а диапазон `2022-09-01 - 2022-12-31` пропущен, т.к. в бд уже есть.

### В среднем отчёт за один день весит ~15мб-30мб

### invalidJson в поле "Event Value"

При парсинге данных наткнулся на то, что в csv-файле в поле "Event Value" инвалидный json. А т.к. в базе данных posgress это поле имеет тип JSON, то сделал для подобных записей структуру `{..., {Event Value: {invalidJson: <кривые данные из этого поля>}}` (+1 вложенность)

## Auth. Если 403 (Forbidden)

Вставить в браузере куку document.cookie="dkgs2frff4rgh43=dk2gsf2rf4frgh"

## ------------------------------------------↓↓↓[сделаю при необходимости...]↓↓↓------------------------------------------

### При установке флага `force=true`, например `from=2022-12-17&to=2022-12-18&geo=US&type=organic&force=true` весь диапазон будет удалён из бд, если есть, и запрошен с API appsflyer в бд заново.

Может понадобиться, если загрузить данные за текущий еще не окончившийся день, а потом попытаться перекачать данные еще раз, когда день кончится например, чтоб были полные данные

## ------------------------------------------↑↑↑[сделаю при необходимости...]↑↑↑------------------------------------------
